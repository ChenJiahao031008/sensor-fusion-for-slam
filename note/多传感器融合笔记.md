## 多传感器融合课程学习笔记

[TOC]

### 第一章：环境构建和概述

#### 1 docker相关

1. docker管理工具：[Portainer](https://www.jianshu.com/p/6234ffaf7203)

2. 安装及配置：详见课程相关的ReadMe文档

3. 常用命令：

   ```bash
   # docker启动       
   systemctl start docker
   service docker start
   # 重启docker服务
   systemctl restart  docker
   sudo service docker restart
   # 关闭docker    
   systemctl stop docker
   service docker stop
   # 查看是否启动成功
   docker ps -a
   ```

### 第2章：3D激光里程计（一）

#### 1 直接匹配：ICP方法

1. 推导SVD分解中的理解：
   + 第15页PPT推导出等价于最大化$\text{Trace}(RH)$；第16页证明了存在正定阵$AA^T$，对于任意一个正交矩阵$B$，有$\text{Trace}(AA^T)\ge\text{Trace}(BAA^T)$，但其中有两个点没有详细说明：
   + 为什么$RH$一定是正定矩阵：==这一点尚不清楚==
   + 为什么16页中公式中各个符号在ICP中代表了什么：由旋转矩阵的定义得知，旋转矩阵是一个行列式为1的正交矩阵，因此，对于其他变化$R^{'}$，$\text{Trace}(RH)\ge\text{Trace}(R^{'}RH)$。
2. 其他解法：参考[文献](https://igl.ethz.ch/projects/ARAP/svd_rot.pdf)，个人更加偏好这种思路，规避了之前16页公式的证明。

#### 2 ICP系列汇总

1. 点云预处理：均匀采样，随机采样，法空间采样（目的是更多的去除平面等纹理稀疏地方的点（很容易出现病态等问题），而非边、角等纹理密集区域的点）
2. loss模型：点到点（ICP，但是不能保证每次采样一致性），点到线（PLICP，共线模型），点到面，面到面
3. 求解方法：SVD方法，迭代优化方法
4. 增加鲁棒性：NICP

#### 3 直接匹配：NDT方法

1. NDT核心：采用基于概率的栅格方法求解联合概率分布
2. 雅各比公式推导：采用旋转角而非李代数形式，不是不行，而是与现有公开资料保持一致。

#### 4 NDT系列汇总

1. 点云预处理：均匀采样，随机采样，法空间采样
2. 栅格策略：固定尺寸栅格，八叉树（栅格尺寸不固定），聚类后取栅格（去除离散点，节约计算量）
3. 增加鲁棒性：三线插值（解决格子切分带来的不连续，但是需要具体问题具体分析）

#### 5 点云畸变补偿

1. 产生：机械雷达分帧（转一圈有一帧，因此可以帧与帧之间匹配，但是转圈有时间）
2. **优点**： 有足够数量的点云才能进行匹配，且一周正好是周围环境的完整采集。
   **缺点**： 每个激光点的坐标都是相对于雷达的，雷达运动时，不同激光点的坐标原点会不同
3. 畸变类型：
   + 平移带来的畸变：扫描标准圆为螺旋线
   + 旋转带来的畸变：扫描标准圆为缺口圆
4. 补偿方法：
   + 角速度和线速度输入： 可以使用imu、 编码器等外接传感器，一般情况下，imu测量角速度，轮式里程计测量线速度
   + 由于激光畸变原理是在2D平面上产生的，因此z轴不参与畸变矫正

### 第3章：3D激光里程计（二）

#### 1 点线面几何基础

1. 向量计算及微分性质
   $$
   \frac{\partial a\cdot b}{\partial a} = b 
   $$
   
   $$
   \frac{\partial a^\wedge{}b}{\partial a} = 
   -\frac{\partial b^\wedge{}a}{\partial a} = -b^\wedge{}
   $$
   
   $$
   a^\wedge{}b = -b^\wedge{}a
   $$
   
2. 点到直线的距离模型：

   <img src="多传感器融合笔记.assets/image-20210822104050724.png" alt="image-20210822104050724" style="zoom:50%;" />
   $$
   d = |\vec{AD}| = \frac{|\vec{AB}\times\vec{AC}|}{|\vec{BC}|}
   $$

   + 叉乘的模$|\vec{AB}\times\vec{AC}|$表示构成平行四边形的面积
   + 总体思路是平行四边形面积除以对角线长度

3. 点到平面的距离模型：

   <img src="多传感器融合笔记.assets/image-20210822104952125.png" alt="image-20210822104952125" style="zoom:50%;" />
   $$
   \vec{n}= \frac{\vec{BC}\times\vec{BD}}{|\vec{BC}\times\vec{BD}|}\\
   d = |\vec{AE}| = \vec{AB} \cdot \vec{n}
   $$

   + 公式中$\vec{n}$为平面的单位法向量
   + 点乘$a\cdot b$的结果等价于向量a到向量b上投影的长度

#### 2 点线面特征提取

1. 按线数分割（**仅限于点云中不包含所在线数的信息情况下**）

   + 该束激光相比于雷达水平面的倾角：$\omega = \arctan(\frac{z}{\sqrt{x^2+y^2}})$
   + 根据倾角和雷达内参(各扫描线的设计倾角)，可知雷达属于哪条激光束。

2. 计算简化曲率（下述公式采用程序实际做法）

   + 对于多线激光雷达来说，计算曲率 c是分别针对单个线进行的。

   + 参考[博客](https://blog.csdn.net/robinvista/article/details/104379087)
   
   + 曲率计算公式：
     $$
     c = \frac{1}{||X||}||\sum_i{(X-X_i)}||_{xyz}^2
     $$
     
   + 曲率计算含义：根据前后各5个点与当前点的长度(长度指激光点到雷达的距离)，计算曲率大小，表现平面的弯曲程度。当c趋近于0时，近似平面。
   
3.  按曲率大小筛选特征点

   + 共分4类：曲率特别大的点(sharp)，曲率不太大的点(less_sharp)，曲率不太小的点(less_flat)，曲率特别小的点(flat)【曲率从大到小排序】
   + 实际使用时：
     + sharp 为”点到直线“中的“点”；
     + sharp 和 less_sharp 为 “点到直线”中的直线；
     + flat 为“点到平面”中的“点”；
     + flat 和 less flat 为 “点到平面”中的”平面“

#### 3 基于线面特征的位姿变化 

1. 帧间关联

   + 线特征关联：当$p_i$为sharp 时，在上一帧中搜索离点最近的线特征点，并在上一帧的相邻线上再找一个线特征点，组成直线。
     + **注意，这里的线指的是竖直的线**
   + 面特征关联：当$p_i$为flat 时，在上一帧中搜索离点最近的面特征点，并在相邻线上找两个面特征点，组成平面。

2. 残差函数：即**点到线、面的距离**函数

   + 其中，代码中点到直线距离采用的矢量形式，理论上$f^Tf$后是无差别的

   + 线特征的残差函数：

     <img src="多传感器融合笔记.assets/image-20210822144707792.png" alt="image-20210822144707792" style="zoom:50%;" />

   + 面特征残差函数：

     <img src="多传感器融合笔记.assets/image-20210822144742833.png" alt="image-20210822144742833" style="zoom:50%;" />

3. 雅各比矩阵：

   + 线特征的雅各比矩阵
     $$
     J_{\xi} = \frac{\partial{d_\xi}}{\partial T} 
     = \frac{\partial{d_\xi}}{\partial p_i}\cdot \frac{\partial{p_i}}{\partial T}
     $$
     其中：(详细推导见14讲)
     $$
     \begin{align}
     &\frac{\partial{p_i}}{\partial t} = I\\
     &\frac{\partial{p_i}}{\partial R} = -(Rp_i+t)^{\wedge}\\
     \end{align}
     $$
     对于$\frac{\partial{d_\xi}}{\partial p_i}$，有：
     $$
     \begin{align}
     \frac{\partial{d_\xi}}{\partial \tilde{p_i}} = &\frac{1}{|p_a-p_b|}\cdot
     	(\frac{
     		\partial{(\tilde{p_i}-p_b)^{\wedge}(\tilde{p_i}-p_a)}
     	}{\partial(\tilde{p_i}-p_a)}\cdot 
     	\frac{\tilde{p_i}-p_a}{\partial\tilde{p_i}}
         - 
     	\frac{
     		\partial{(\tilde{p_i}-p_a)^{\wedge}(\tilde{p_i}-p_b)}
     	}{\partial({\tilde{p_i}-p_b})}\cdot 
     	\frac{\tilde{p_i}-p_b}{\partial\tilde{p_i}})\\
     
     =&\frac{1}{|p_a-p_b|}\cdot
     	((\tilde{p_i}-p_b)^{\wedge}-(\tilde{p_i}-p_a)^{\wedge})\\
     =& \frac{(p_a-p_b)^{\wedge}}{|p_a-p_b|}
     	
     \end{align}
     $$
     其中，(10) 到 (11) 为公式 (2) 推导，公式 (11) 到 (12) 表示反对称矩阵可以内部加减。

   + 面特征的雅各比矩阵：
     $$
     \begin{align}
     J_\xi = \frac{\partial{d_{\mathcal{H}}} }{\partial T} &= 
     	\frac{\partial{d_{\mathcal{H}}}}{\partial \tilde{p_i}} \cdot
     	\frac{\partial{\tilde{p_i}}}{\partial T}
     \end{align}
     $$
     其中，令
     $$
     X = (\tilde{p_i}-p_j)\cdot\frac{(p_l-p_j)\times(p_m-p_j)}{|(p_l-p_j)\times(p_m-p_j)|}
     $$
     

     有：
     $$
     \frac{\partial{d_{\mathcal{H}}}}{\partial \tilde{p_i}} = 
     \frac{\partial|X|}{\partial \tilde{p_i}} = 
     \frac{\partial|X|}{\partial X} \cdot
     \frac{\partial X}{\partial \tilde{p_i}} =
     \frac{X}{|X|}\cdot\frac{\partial X}{\partial \tilde{p_i}} \\
     \frac{\partial X}{\partial \tilde{p_i}} =
     \frac{(p_l-p_j)\times(p_m-p_j)}{|(p_l-p_j)\times(p_m-p_j)|}
     $$
     物理意义上，它代表的是平面的单位法向量。

#### 4 基于特征的里程计实现

1. 整体框图：

   <img src="多传感器融合笔记.assets/image-20210822163109582.png" alt="image-20210822163109582" style="zoom:50%;" />

2. 框图关键点理解和分析：

   + **帧与帧的匹配 vs 帧与模型的匹配**：由于雷达信息的分辨率不高，在远处获得的特征往往不稳定，特征也比较稀疏，往往难以匹配。因此一个好的想法是建立一个map，将多帧雷达信息融合起来做匹配，这样的特征就足够稠密
   + **两种模型的混合使用**：帧到模型的匹配耗时较大，因此往往每隔几帧才进行一次以保证实时性。
   + **LOAM的老式地图管理策略**：（这部分在之后不再使用）老式管理策略不区分帧的来源，将所有帧的雷达信息融合在一起，这带来两个问题，一是无法使用之前帧与帧之前匹配策略，不过它给出了基于主方向的解决思路；第二个问题是这种老式策略在之后被抛弃的主要原因，假如我第10帧时候发现之前第5帧的数据不对，想要调整，但是这时候由于数据都是混合在一起的，因此无法单独分离出来。

### 第四章：点云地图构建及基于地图的定位

#### 1 回环检测

1. 作用：
   + 有了RTK还需要回环检测吗？需要。RTK得到的结果尽管很高，但是仍然有厘米级别的误差，如果在一条路上重复，可能会造成两次误差相加，造成分米级别的误差，用回环检测还是很有必要的。
2. 分类：
   + 有初始相对位姿：ICP，NDT系列
   + 无初始相对位姿：
     + 非学习方法：[scan context](https://github.com/irapkaist/scancontext)，[特征直方图](https://github.com/hku-mars/loam_livox)
     + 基于学习方法：segmap，PointNetVLAD

#### 2 后端优化

1. 结构组成：

   <img src="多传感器融合笔记.assets/image-20210829113808233.png" alt="image-20210829113808233" style="zoom: 33%;" />

2. 后端优化基本原理：

   + 观测：
     + 连续两帧的相对位姿观测；
     + 回环匹配得到的相对位姿观测；
     + 组合导航提供的先验位姿观测。
   + 使用方式：
     + 1)和2)的观测构成了基于回环的位姿修正；（在没有GPS的情况下使用）
     + 1)和3)的观测构成了基于先验观测的位姿修正；（不用回环，不推荐）
     + 1) 2) 3) 也可以同时使用。（推荐）

3. 李群、李代数基本知识：参考PPT

4. **基于回环的位姿修正**

   + 误差项：
     $$
     e_{ij} = \ln(T_{ij}^{-1}T_i^{-1}T_j) = \ln(\exp(-\xi_{ij}^{\wedge})\exp(-\xi_{i}^{\wedge})\exp(\xi_{j}^{\wedge}))
     $$
   + 雅各比矩阵：
     $$
     \begin{align}
     	\hat{e_{ij}} =&  \ln(T_{ij}^{-1} T_i^{-1}
     	\exp((-\delta\xi_i)^{\wedge})
     	\exp(\xi_j^{\wedge}) T_j )^{\vee}\\
     =&\ \ln\left(T_{ij}^{-1} T_i^{-1}
     	\exp\left((-\delta\xi_i)^{\wedge}\right) T_j 
     	\exp\left((\text{Ad}(T_j^{-1})\xi_j)^{\wedge}\right)\right)^{\vee}\\
     =&\ \ln\left(T_{ij}^{-1} T_i^{-1} T_j 
     	\exp\left((-\text{Ad}(T_j^{-1})\delta\xi_i)^{\wedge}\right) 
     	\exp\left((\text{Ad}(T_j^{-1})\delta\xi_j)^{\wedge}\right)\right)^{\vee}\\
     =&\ \ln\left(T_{ij}^{-1} T_i^{-1} T_j 
     	\exp\left((-\text{Ad}(T_j^{-1})\delta\xi_i)^{\wedge}
     	+ (\text{Ad}(T_j^{-1})\delta\xi_j)^{\wedge}\right)\right)^{\vee}\\
     =&\ \ln\left(\exp(e_{ij}) 
     	\exp\left((-\text{Ad}(T_j^{-1})\delta\xi_i)^{\wedge}
     	+ (\text{Ad}(T_j^{-1})\delta\xi_j)^{\wedge}\right)\right)^{\vee}\\
     \thickapprox& \ e_{ij}
     	-\mathcal{J}^{-1}_r(e_{ij}) \text{Ad}(T_j^{-1})\delta\xi_i
     	+\mathcal{J}_r^{-1}(e_{ij}) \text{Ad}(T_j^{-1})\delta\xi_i\\
     	
     A_{ij} 
     =&\ \frac{\partial e_{ij}}{\partial \delta\xi_i} 
     = -\mathcal{J}^{-1}_r(e_{ij}) \text{Ad}(T_j^{-1})\\
     
     B_{ij} 
     =&\ \frac{\partial e_{ij}}{\partial \delta\xi_j} 
     = \mathcal{J}^{-1}_r(e_{ij}) \text{Ad}(T_j^{-1})\\
     
     \mathcal{J}^{-1}_r(e_{ij}) \thickapprox&\ I + \frac{1}{2}
     	\begin{bmatrix}
     	\phi_e^{\wedge} & \rho_e^{\wedge} \\ 0 & \phi_e^{\wedge}
     	\end{bmatrix}
     \end{align}
     $$

   + 公式18,19采用李代数的伴随性质；公式20采用微小变换下BCH公式，公式21表示非微小变化下BCH公式

5. **基于先验观测的位姿修正**

   + ![image-20210829171324574](多传感器融合笔记.assets/image-20210829171324574.png)

#### 3 点云地图的创立

<img src="多传感器融合笔记.assets/image-20210829173048842.png" alt="image-20210829173048842" style="zoom:33%;" />

#### 4 基于地图的定位

1. 在地图匹配中，鲁棒性和运行速度更加重要，因此实际使用中，基于NDT的匹配使用更广泛。注意，由于NDT匹配需要较准确的初始位姿，因此在定位之前需要初始化环节，给出载体的初始位姿

2. <img src="多传感器融合笔记.assets/image-20210829200336996.png" alt="image-20210829200336996" style="zoom:33%;" />

#### 5 LeGO-LOAM介绍

1.  主要特点：
   + 对地面做了分割，减小了特征搜索范围；
   + 提取特征之前做了聚类，提高了特征质量；
   + 以帧为单位进行优化，使得全局地图可以多次调整，而不像LOAM那样不可修改；
   + 增加了回环修正。
   
2. 特征提取
   + 根据线与线之间的夹角，以及点的曲率，筛选出地面点。**所有用于匹配的平面点仅使用地面点**。
   + 在非地面点中，使用广度优先搜索(BFS)做聚类，**聚类中点的数量大于30，才用来筛选线特征**。
   + 筛选线特征方法，与LOAM中相同。
   
3. 位姿解算:
   + **使用地面面特征优化高度和水平角**；
   + **使用线特征优化水平位移和航向角**。
   + 注意：实际代码中，**只有odom环节(scan2scan)使用了该模式**，在mapping环节(scan2map)仍使用的是六自由度模型。猜测是因为里程计中特征稀疏，更多的处于水平位移和航向角的优化范围，并且这样做简化的计算负担，符合里程计的要求。
   
4. 回环检测
   + 使用的初始位姿，采用前端里程计位姿
   + 匹配采用 ICP 方法
   + 优化库采用 gtsam（参考泡泡机器人）
   
5.  代码部分：

    + 关于速度的处理：

      ```c++
      Eigen::Vector3d delta_v;
      delta_v(0) = w(1) * t(2) - w(2) * t(1);
      delta_v(1) = w(2) * t(0) - w(0) * t(2);
      delta_v(2) = w(0) * t(1) - w(1) * t(0);
      v += delta_v;
      // b. transform velocities in IMU frame to lidar frame:
      w = R.transpose() * w;
      v = R.transpose() * v;
      ```

      其中，$R = R_{\text{lidar}}^{\text{imu}},t = t_{\text{lidar}}^{\text{imu}}$。原理如下，$v_{\text{imu}}$表示imu本体的线速度，$w\times t$是由于旋转产生的速度分量
      $$
      v = v_{\text{imu}} + w\times r =  v_{\text{imu}} + w\times t
      $$


### 第5章：惯性导航原理及误差分析

#### 1 惯性技术简介

1. 各种陀螺类别：
   + 机械陀螺：除了少部分军用，已经没有人再使用了，可以视为已经被淘汰
   + 激光/光纤陀螺：精度高。利用Sagnac效应，其原理是干涉仪相对惯性空间静止时, 光路A 和 B 的光程相等，当有角速度时，光程不相等，便会产生干涉。
   + **MEMS陀螺**：最常用的一种陀螺，基于科氏力原理。
2. 更多补充知识其实可以参考从零手写VIO课程

#### 2 惯性器件的误差分析

1. Allan方差分析

   + Allan方差分析时，包含五种分析：量化噪声、角度随机游走、角速率游走、零偏不稳定性、速率斜坡，不包含对零偏重复性的分析。但是实际使用时，**只有角度随机游走和角速率游走被采用**，其他误差项，仅起到了解器件精度水平的作用。
   +  角度随机游走，在融合时作为陀螺仪的噪声使用。(有时也以零偏不稳定性当做噪声)。角速度随机游走，作为陀螺仪微分项中的噪声
   + 实际融合时， Allan分析的结果，只是作为初值使用，需要在此基础上调参。

2.  开源实现：https://github.com/gaowenliang/imu_utils

3. ![image-20210912144152019](多传感器融合笔记.assets/image-20210912144152019.png)

   ![image-20210912144214061](多传感器融合笔记.assets/image-20210912144214061.png)

#### 3 惯性器件内参标定

1. 惯性器件内参误差模型
   $$
   \begin{align}
   W 	&= K_g(I+S_g)\omega+b_g\\
   	&= (I+\Delta K_g)(I+S_g)\omega+b_g\\
   	&= (I+\Delta K_g + S_g +\Delta K_g\cdot S_g )\omega+b_g\\
   	&\approx (K_g+S_g)\omega+b_g
   \end{align}
   $$
   从29-30：两个小量的乘积属于微小量，可以忽略。

   展开形式为：

   <img src="多传感器融合笔记.assets/image-20210912140944458.png" alt="image-20210912140944458" style="zoom: 50%;" />

   其中$Sgxz$表示对于陀螺仪而言，绕z轴旋转对x轴产生的安装误差，$K$表示刻度系数误差，$b$表示零偏。

2. **基于转台的标定**

   + 基于转台的标定精度较高，但标定成本高；

   + 解析法-加速度计标定：

     ![image-20210912141237554](多传感器融合笔记.assets/image-20210912141237554.png)

   + 最小二乘法-加速度计标定：

     <img src="多传感器融合笔记.assets/image-20210912141351755.png" alt="image-20210912141351755" style="zoom: 43%;" />

     转台在每个位置都可以得到一个方程：$y_i = x_i\theta$，多个方程联立为：$Y=X\theta$。采用最小二乘法得到通解：$\theta = (X^{\top}X)^{-1}X^{\top}Y$。

   + 解析法：陀螺仪标定：转台一般角速度不如角度精度高，因此不是直接以角速度作为真值，而是以积分得到的角度作为真值。（角速度是围绕某条线进行波动的）

     ![image-20210912143303273](多传感器融合笔记.assets/image-20210912143303273.png)

     ![image-20210912143343548](多传感器融合笔记.assets/image-20210912143343548.png)

3. **无转台标定**

   + 论文：A Robust and Easy to Implement Method for IMU Calibration without External Equipments

     代码：https://github.com/Kyle-ak/imu_tk

   + 特点：不依赖转台的标定精度差，但成本低、效率高，对一般MEMS的标定需求已经足够

   + 内参模型：

     ![image-20210912144439828](多传感器融合笔记.assets/image-20210912144439828.png)

     注意：由于不需要和转台对齐，因此坐标系设置比较灵活，采用这种方式能消除安装误差系数矩阵中冗余的自由度，使其变成一个上三角或者下三角矩阵。

   + 优化模型：

     ![image-20210912145734967](多传感器融合笔记.assets/image-20210912145734967.png)

     ![image-20210912150753232](多传感器融合笔记.assets/image-20210912150753232.png)

     ![image-20210912151313325](多传感器融合笔记.assets/image-20210912151313325.png)





### 附加：答疑关键点记录

#### 8.28 答疑

1. **Loam不适合建图，适合里程计；NDT适合实时地图匹配，鲁棒性比较好，并且存储量比较小；ICP精度较高，适合建图，地图生产。**
2. 学习建议：从简单到复杂构建系统框架，不用为后续功能留接口。工程中遇到问题再重写第三方库
3. **gnss：相当于gps，用4个卫星处理，位置不准确; rtk：两个gps，一个动一个不动（基站，有范围，现在有千寻等虚拟基站，在gps上做补偿)，抵消误差**
4. 点线特征误差大，会产生重影和伪线特征，在scan2scan会比较好，但在scan2map上比较差，误差可以想办法去除不好的点线，但是loam的确不适合建图，只适合里程计使用
5. Z轴漂移，gps融合即可，虽然有误差，但是没有累计的漂移
6. 单位化的位置，利用没有单位化的旋转将t求解出来再单位化，并且每次迭代时候单位化比较好
7. 面试：每次测试实际场景最常见的头部问题是什么，怎么解决的
8. <重构> 这本书可以看下
9. Imu误差参数补偿，标定很重要，处理误差的细节是关键
10. 评价标准：真值，重复性，
11. 高精地图开源方案：hdl graph slam







